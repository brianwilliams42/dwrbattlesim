<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dragon Warrior Battle Simulator</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" />
  <style>
    body {
      font-family: 'Press Start 2P', sans-serif;
      margin: 20px;
      background-color: #000;
      color: #fff;
    }
    fieldset {
      margin-bottom: 15px;
      border: 2px solid #555;
      background-color: #111;
    }
    label {
      display: block;
      margin-top: 5px;
    }
    input[type='number'] {
      width: 4em;
    }
    button {
      margin-top: 10px;
      padding: 5px 10px;
      background-color: #333;
      color: #fff;
      border: 2px solid #555;
    }
    .sprite {
      width: 64px;
      height: 64px;
      image-rendering: pixelated;
    }
    .sprites {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    #sim-form {
      flex: 1 1 500px;
    }
    #results {
      flex: 1 1 400px;
      border: 2px solid #555;
      background-color: #111;
      padding: 15px;
      font-size: 14px;
      line-height: 1.4;
    }
    #results section {
      margin-bottom: 20px;
    }
    #results h2 {
      margin: 0 0 10px;
      font-size: 16px;
    }
    #results pre {
      margin: 0;
    }
    .zone-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 10px;
    }
    .zone-tab {
      flex: 1;
      padding: 5px;
      border: 2px solid #555;
      background-color: #222;
      cursor: pointer;
      text-align: center;
    }
    .zone-tab.active {
      background-color: #333;
    }
    .zone-tab small {
      display: block;
      font-size: 10px;
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Dragon Warrior Battle Simulator</h1>
    <p><small><a href="https://github.com/brianwilliams42/dwrbattlesim/blob/main/README.md">Instructions and source code</a></small></p>
    <div class="sprites">
      <svg class="sprite" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
        <rect width="16" height="16" fill="#000" />
        <rect x="7" y="2" width="2" height="2" fill="#f2d7b0" />
        <rect x="7" y="4" width="2" height="4" fill="#00f" />
        <rect x="9" y="5" width="3" height="1" fill="#ccc" />
        <rect x="7" y="8" width="1" height="3" fill="#f2d7b0" />
        <rect x="8" y="8" width="1" height="3" fill="#f2d7b0" />
        <rect x="6" y="5" width="1" height="2" fill="#f2d7b0" />
      </svg>
      <svg class="sprite" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" shape-rendering="crispEdges">
        <rect width="16" height="16" fill="#000" />
        <path d="M8 3 L4 8 L4 12 L12 12 L12 8 Z" fill="#00f" />
        <rect x="6" y="8" width="1" height="1" fill="#fff" />
        <rect x="9" y="8" width="1" height="1" fill="#fff" />
        <rect x="7" y="10" width="2" height="1" fill="#f00" />
      </svg>
    </div>
    <div class="layout">
      <form id="sim-form">
    <fieldset>
      <legend>Hero Stats</legend>
      <label>HP <input type="number" id="hero-hp" value="100" /></label>
      <label>Strength <input type="number" id="hero-strength" value="50" /></label>
      <label>Weapon
        <select id="hero-weapon">
          <option value="0">None</option>
          <option value="2">Bamboo Pole</option>
          <option value="4">Club</option>
          <option value="10">Copper Sword</option>
          <option value="15">Hand Axe</option>
          <option value="20">Broad Sword</option>
          <option value="28">Flame Sword</option>
          <option value="40">Erdrick's Sword</option>
        </select>
      </label>
      <label><input type="checkbox" id="hero-fighters-ring" /> Fighter's Ring</label>
      <label><input type="checkbox" id="hero-death-necklace" /> Death Necklace</label>
      <label>Defense <input type="number" id="hero-defense" value="40" /></label>
      <label>Armor
        <select id="hero-armor">
          <option value="none">No abilities</option>
          <option value="magic">Magic Armor</option>
          <option value="erdrick">Erdrick's Armor</option>
        </select>
      </label>
      <label>Agility <input type="number" id="hero-agility" value="30" /></label>
      <label>MP <input type="number" id="hero-mp" value="50" /></label>
      <label>Herbs <input type="number" id="hero-herbs" value="0" min="0" max="6" /></label>
      <label>Fairy Water <input type="number" id="hero-fairy-water" value="0" min="0" max="8" /></label>
      <label><input type="checkbox" id="hero-hurt" /> HURT</label>
      <label><input type="checkbox" id="hero-hurtmore" /> HURTMORE</label>
      <label><input type="checkbox" id="hero-heal" /> HEAL</label>
      <label><input type="checkbox" id="hero-healmore" /> HEALMORE</label>
      <label><input type="checkbox" id="hero-stopspell" /> STOPSPELL</label>
      <label><input type="checkbox" id="hero-sleep" /> SLEEP</label>
      <label><input type="checkbox" id="hero-repel" /> REPEL</label>
      <label><input type="checkbox" id="hero-flute" /> Fairy Flute</label>
    </fieldset>
    <fieldset id="monster-config">
      <legend>Monster Stats</legend>
      <label>Enemy
        <select id="enemy-select"></select>
      </label>
      <label><input type="checkbox" id="use-preset" checked /> Use preset monster stats</label>
      <div id="monster-stats" style="display:none">
        <label>HP <input type="number" id="mon-hp" value="80" /></label>
        <label>Attack <input type="number" id="mon-attack" value="40" /></label>
        <label>Defense <input type="number" id="mon-defense" value="30" /></label>
        <label>Agility <input type="number" id="mon-agility" value="20" /></label>
        <label>HURT Resist (0-15) <input type="number" id="hurt-resist" value="0" /></label>
        <label>Dodge (0-64) <input type="number" id="mon-dodge" value="2" /></label>
        <label>XP Reward <input type="number" id="mon-xp" value="120" /></label>
        <label>Sleep Resist (0-15) <input type="number" id="sleep-resist" value="0" /></label>
        <label>Group (1-4) <input type="number" id="mon-group" value="2" min="1" max="4" /></label>
      </div>
      <label style="margin-top:10px">Stopspell Resist (0-15) <input type="number" id="stopspell-resist" value="0" /></label>
      <label style="margin-top:10px">Support Ability
        <select id="mon-support">
          <option value="">None</option>
          <option value="sleep">Sleep</option>
          <option value="stopspell">Stopspell</option>
          <option value="heal">Heal</option>
          <option value="healmore">Healmore</option>
        </select>
        Chance
        <select id="mon-support-chance">
          <option value="0.25">25%</option>
          <option value="0.5">50%</option>
          <option value="0.75">75%</option>
        </select>
      </label>
      <label style="margin-top:10px">Attack Ability
        <select id="mon-attack-ability">
          <option value="">None</option>
          <option value="hurt">HURT</option>
          <option value="hurtmore">HURTMORE</option>
          <option value="smallbreath">Small Breath</option>
          <option value="bigbreath">Big Breath</option>
        </select>
        Chance
        <select id="mon-attack-chance">
          <option value="0.25">25%</option>
          <option value="0.5">50%</option>
          <option value="0.75">75%</option>
        </select>
      </label>
    </fieldset>
    <fieldset id="zone-config" style="display:none">
      <legend>Zone Enemies</legend>
      <div id="zone-enemies-container"></div>
    </fieldset>
    <fieldset id="zone-settings" style="display:none">
      <legend>Zone Settings</legend>
      <label>Encounter Rate
        <select id="zone-encounter-rate" data-ignore="1">
          <option value="8">1/8</option>
          <option value="16">1/16</option>
          <option value="21">1/21</option>
        </select>
      </label>
    </fieldset>
    <fieldset>
      <legend>Battle Strategy</legend>
      <label>Spell Resistance Threshold (0-15)
        <input type="number" id="spell-resist-threshold" value="5" min="0" max="15" />
      </label>
    </fieldset>
    <fieldset>
      <legend>Simulation Settings</legend>
      <details>
        <summary>Timing Settings (frames, optional)</summary>
        <p><strong>Hero actions</strong></p>
          <label>Hero Attack <input type="number" id="hero-attack-time" value="145" /></label>
          <label>Hero Spell <input type="number" id="hero-spell-time" value="180" /></label>
          <label>Hero Sleep/Stopspell <input type="number" id="hero-sleep-stopspell-time" value="240" /></label>
          <label>Hero Sleep Turn <input type="number" id="hero-sleep-time" value="35" /></label>
          <label>Critical Hit <input type="number" id="hero-critical-time" value="30" /></label>
          <label>Herb Use <input type="number" id="herb-time" value="130" /></label>
          <label>Fairy Water Use <input type="number" id="fairy-water-time" value="245" /></label>
          <label>Fairy Flute <input type="number" id="fairy-flute-time" value="470" /></label>
          <label>Run Fail <input type="number" id="hero-run-fail-time" value="150" /></label>
          <label>Run Success <input type="number" id="hero-run-success-time" value="40" /></label>
          <label>Herb Use Between Fights <input type="number" id="herb-between-time" value="135" /></label>
          <label>Heal Spell Between Fights <input type="number" id="heal-spell-time" value="190" /></label>
        <p><strong>Enemy actions</strong></p>
          <label>Enemy Attack <input type="number" id="enemy-attack-time" value="130" /></label>
          <label>Enemy Hurt Spell <input type="number" id="enemy-hurt-spell-time" value="190" /></label>
          <label>Enemy Heal Spell <input type="number" id="enemy-heal-spell-time" value="165" /></label>
          <label>Enemy Stopspelled Spell <input type="number" id="enemy-stopspelled-spell-time" value="165" /></label>
          <label>Enemy Other Spell <input type="number" id="enemy-spell-time" value="150" /></label>
          <label>Enemy Breath <input type="number" id="enemy-breath-time" value="135" /></label>
          <label>Enemy Dodge <input type="number" id="enemy-dodge-time" value="80" /></label>
          <label>Enemy Sleep Turn <input type="number" id="enemy-sleep-time" value="50" /></label>
        <p><strong>Battle flow</strong></p>
          <label>Pre-Battle <input type="number" id="pre-battle-time" value="140" /></label>
          <label>Ambush <input type="number" id="ambush-time" value="50" /></label>
          <label>Monster Flee <input type="number" id="monster-flee-time" value="100" /></label>
          <label>Post-Battle <input type="number" id="post-battle-time" value="200" /></label>
      </details>
      <label>Mode
        <select id="sim-mode">
          <option value="single">Single Battle</option>
          <option value="repeated">Repeated Fights</option>
          <option value="zone">Zone Grind</option>
        </select>
      </label>
      <label id="frames-between-fights-label" style="display: none; margin-top:10px">Frames Between Fights <input type="number" id="frames-between-fights" value="30" /></label>
      <label id="refill-seconds-label" style="display: none; margin-top:10px">Refill Time (sec) <input type="number" id="refill-seconds" value="75" /></label>
      <label>Iterations <input type="number" id="iterations" value="1000" /></label>
    </fieldset>
    <button type="submit">Simulate</button>
    <button type="button" id="share-url">Copy Share URL</button>
  </form>
  <div id="results">
    <section>
      <h2>Battle Metrics</h2>
      <pre id="metrics"></pre>
    </section>
    <section>
      <h2>Sample Battle</h2>
      <pre id="sample-battle"></pre>
    </section>
  </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <script type="module">
    import { simulateMany, simulateBattle, simulateRepeated, simulateZone } from './simulator.js';

    const form = document.getElementById('sim-form');
    const metricsEl = document.getElementById('metrics');
    const sampleEl = document.getElementById('sample-battle');
    const enemySelect = document.getElementById('enemy-select');
    const usePreset = document.getElementById('use-preset');
    const monsterStats = document.getElementById('monster-stats');
    const monsterConfig = document.getElementById('monster-config');
    const shareBtn = document.getElementById('share-url');
    const betweenFightsLabel = document.getElementById('frames-between-fights-label');
    const refillSecondsLabel = document.getElementById('refill-seconds-label');
    const simModeSelect = document.getElementById('sim-mode');
    const zoneConfig = document.getElementById('zone-config');
    const zoneSettings = document.getElementById('zone-settings');
    const zoneEnemiesContainer = document.getElementById('zone-enemies-container');
    const fieldIds = Array.from(form.elements)
      .filter((el) => el.id && el !== shareBtn && !el.dataset.ignore)
      .map((el) => el.id);
    const encodedData = location.hash.slice(1);

    function toBase64Url(str) {
      return str.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function fromBase64Url(str) {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      while (str.length % 4) str += '=';
      return str;
    }

    function getZoneFormData() {
      const zoneMonsters = [];
      for (let i = 0; i < 5; i++) {
        const usePreset = document.getElementById(`zone-use-preset-${i}`).checked;
        const name = document.getElementById(`zone-enemy-select-${i}`).value;
        const runFrom = document.getElementById(`zone-run-${i}`).checked ? 1 : 0;
        if (usePreset) {
          zoneMonsters.push([1, name, runFrom]);
        } else {
          zoneMonsters.push([
            0,
            name,
            Number(document.getElementById(`zone-mon-hp-${i}`).value),
            Number(document.getElementById(`zone-mon-attack-${i}`).value),
            Number(document.getElementById(`zone-mon-defense-${i}`).value),
            Number(document.getElementById(`zone-mon-agility-${i}`).value),
            Number(document.getElementById(`zone-hurt-resist-${i}`).value),
            Number(document.getElementById(`zone-mon-dodge-${i}`).value),
            Number(document.getElementById(`zone-mon-xp-${i}`).value),
            Number(document.getElementById(`zone-stopspell-resist-${i}`).value),
            Number(document.getElementById(`zone-sleep-resist-${i}`).value),
            Number(document.getElementById(`zone-mon-group-${i}`).value),
            document.getElementById(`zone-mon-support-${i}`).value,
            Number(document.getElementById(`zone-mon-support-chance-${i}`).value),
            document.getElementById(`zone-mon-attack-ability-${i}`).value,
            Number(document.getElementById(`zone-mon-attack-chance-${i}`).value),
            runFrom,
          ]);
        }
      }
      const encounterRate = Number(
        document.getElementById('zone-encounter-rate').value,
      );
      return [encounterRate, zoneMonsters];
    }

    function getFormData() {
      const base = fieldIds.map((id) => {
        const el = document.getElementById(id);
        if (el.type === 'checkbox') return el.checked ? 1 : 0;
        return el.value;
      });
      if (simModeSelect.value === 'zone') base.push(getZoneFormData());
      return base;
    }

    function setZoneFormData(zoneData) {
      if (!zoneData) return;
      const [encounterRate, monsters] = zoneData;
      document.getElementById('zone-encounter-rate').value = encounterRate;
      monsters.forEach((m, i) => {
        const usePreset = m[0] === 1;
        const sel = document.getElementById(`zone-enemy-select-${i}`);
        const preset = document.getElementById(`zone-use-preset-${i}`);
        const run = m[m.length - 1];
        sel.value = m[1];
        preset.checked = usePreset;
        document.getElementById(`zone-run-${i}`).checked = Boolean(run);
        if (!usePreset) {
          document.getElementById(`zone-mon-hp-${i}`).value = m[2];
          document.getElementById(`zone-mon-attack-${i}`).value = m[3];
          document.getElementById(`zone-mon-defense-${i}`).value = m[4];
          document.getElementById(`zone-mon-agility-${i}`).value = m[5];
          document.getElementById(`zone-hurt-resist-${i}`).value = m[6];
          document.getElementById(`zone-mon-dodge-${i}`).value = m[7];
          document.getElementById(`zone-mon-xp-${i}`).value = m[8];
          document.getElementById(`zone-stopspell-resist-${i}`).value = m[9];
          document.getElementById(`zone-sleep-resist-${i}`).value = m[10];
          document.getElementById(`zone-mon-group-${i}`).value = m[11];
          document.getElementById(`zone-mon-support-${i}`).value = m[12];
          document.getElementById(`zone-mon-support-chance-${i}`).value = m[13];
          document.getElementById(`zone-mon-attack-ability-${i}`).value = m[14];
          document.getElementById(`zone-mon-attack-chance-${i}`).value = m[15];
        }
        preset.dispatchEvent(new Event('change'));
        sel.dispatchEvent(new Event('change'));
      });
    }

    function setFormData(data) {
      fieldIds.forEach((id, idx) => {
        const el = document.getElementById(id);
        if (!el) return;
        const val = data[idx];
        if (el.type === 'checkbox') el.checked = Boolean(Number(val));
        else el.value = val;
      });
      if (data.length > fieldIds.length) setZoneFormData(data[fieldIds.length]);
      toggleMonsterStats();
      enemySelect.dispatchEvent(new Event('change'));
      toggleModeDisplays();
    }

    shareBtn.addEventListener('click', () => {
      const data = getFormData();
      const compressed = toBase64Url(
        LZString.compressToBase64(JSON.stringify(data)),
      );
      const url = `${location.origin}${location.pathname}#${compressed}`;
      navigator.clipboard.writeText(url).then(() => alert('URL copied'));
    });

    let enemies = [];

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = (seconds % 60).toFixed(2);
      return `${minutes}m ${secs}s`;
    }

    function setMonsterStats(chosen) {
      document.getElementById('mon-hp').value = chosen.hp;
      document.getElementById('mon-attack').value = chosen.attack;
      document.getElementById('mon-defense').value = chosen.defense;
      document.getElementById('mon-agility').value = chosen.agility;
      document.getElementById('hurt-resist').value = chosen.hurtResist;
      document.getElementById('mon-dodge').value = chosen.dodge ?? 2;
      document.getElementById('mon-xp').value = chosen.xp ?? 0;
      document.getElementById('stopspell-resist').value = chosen.stopspellResist ?? 0;
      document.getElementById('sleep-resist').value = chosen.sleepResist ?? 0;
      document.getElementById('mon-group').value = chosen.group ?? 2;
    }

    function setZoneMonsterStats(idx, chosen) {
      document.getElementById(`zone-mon-hp-${idx}`).value = chosen.hp;
      document.getElementById(`zone-mon-attack-${idx}`).value = chosen.attack;
      document.getElementById(`zone-mon-defense-${idx}`).value = chosen.defense;
      document.getElementById(`zone-mon-agility-${idx}`).value = chosen.agility;
      document.getElementById(`zone-hurt-resist-${idx}`).value = chosen.hurtResist;
      document.getElementById(`zone-mon-dodge-${idx}`).value = chosen.dodge ?? 2;
      document.getElementById(`zone-mon-xp-${idx}`).value = chosen.xp ?? 0;
      document.getElementById(`zone-stopspell-resist-${idx}`).value = chosen.stopspellResist ?? 0;
      document.getElementById(`zone-sleep-resist-${idx}`).value = chosen.sleepResist ?? 0;
      document.getElementById(`zone-mon-group-${idx}`).value = chosen.group ?? 2;
    }

    function populateEnemySelect(sel) {
      sel.appendChild(new Option('Custom', ''));
      for (const e of enemies) sel.appendChild(new Option(e.name, e.name));
    }

    function setupSingleEnemyUI() {
      populateEnemySelect(enemySelect);
      enemySelect.value = enemies[0]?.name || '';
      if (usePreset.checked && enemies[0]) setMonsterStats(enemies[0]);
      usePreset.addEventListener('change', toggleMonsterStats);
      enemySelect.addEventListener('change', () => {
        if (usePreset.checked) updateMonsterStats();
      });
      toggleMonsterStats();
    }

    function setupZoneEnemies() {
      zoneEnemiesContainer.innerHTML =
        '<div id="zone-enemy-tabs" class="zone-tabs"></div><div id="zone-enemy-panels"></div>';
      const tabs = document.getElementById('zone-enemy-tabs');
      const panels = document.getElementById('zone-enemy-panels');
      for (let i = 0; i < 5; i++) {
        tabs.insertAdjacentHTML(
          'beforeend',
          `<div class="zone-tab${i === 0 ? ' active' : ''}" id="zone-tab-${i}" data-index="${i}">Enemy ${i + 1}<br><small id="zone-tab-name-${i}"></small></div>`,
        );
        panels.insertAdjacentHTML(
          'beforeend',
          `<div class="zone-enemy" id="zone-enemy-${i}" style="${i === 0 ? '' : 'display:none'}">
            <label>Enemy <select id="zone-enemy-select-${i}" data-ignore="1"></select></label>
            <label><input type="checkbox" id="zone-use-preset-${i}" data-ignore="1" checked /> Use preset monster stats</label>
            <div id="zone-monster-stats-${i}" style="display:none">
              <label>HP <input type="number" id="zone-mon-hp-${i}" data-ignore="1" /></label>
              <label>Attack <input type="number" id="zone-mon-attack-${i}" data-ignore="1" /></label>
              <label>Defense <input type="number" id="zone-mon-defense-${i}" data-ignore="1" /></label>
              <label>Agility <input type="number" id="zone-mon-agility-${i}" data-ignore="1" /></label>
              <label>HURT Resist (0-15) <input type="number" id="zone-hurt-resist-${i}" data-ignore="1" /></label>
              <label>Dodge (0-64) <input type="number" id="zone-mon-dodge-${i}" data-ignore="1" /></label>
              <label>XP Reward <input type="number" id="zone-mon-xp-${i}" data-ignore="1" /></label>
              <label>Sleep Resist (0-15) <input type="number" id="zone-sleep-resist-${i}" data-ignore="1" /></label>
              <label>Group (1-4) <input type="number" id="zone-mon-group-${i}" data-ignore="1" min="1" max="4" /></label>
            </div>
            <label style="margin-top:10px">Stopspell Resist (0-15) <input type="number" id="zone-stopspell-resist-${i}" data-ignore="1" /></label>
            <label style="margin-top:10px">Support Ability
              <select id="zone-mon-support-${i}" data-ignore="1">
                <option value="">None</option>
                <option value="sleep">Sleep</option>
                <option value="stopspell">Stopspell</option>
                <option value="heal">Heal</option>
                <option value="healmore">Healmore</option>
              </select>
              Chance
              <select id="zone-mon-support-chance-${i}" data-ignore="1">
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
              </select>
            </label>
            <label style="margin-top:10px">Attack Ability
              <select id="zone-mon-attack-ability-${i}" data-ignore="1">
                <option value="">None</option>
                <option value="hurt">HURT</option>
                <option value="hurtmore">HURTMORE</option>
                <option value="smallbreath">Small Breath</option>
                <option value="bigbreath">Big Breath</option>
              </select>
              Chance
              <select id="zone-mon-attack-chance-${i}" data-ignore="1">
                <option value="0.25">25%</option>
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
              </select>
            </label>
            <label><input type="checkbox" id="zone-run-${i}" data-ignore="1" /> Run from this enemy</label>
          </div>`,
        );
        const sel = document.getElementById(`zone-enemy-select-${i}`);
        populateEnemySelect(sel);
        sel.value = enemies[0]?.name || '';
        const tabName = document.getElementById(`zone-tab-name-${i}`);
        tabName.textContent = sel.value || 'Custom';
        const preset = document.getElementById(`zone-use-preset-${i}`);
        const stats = document.getElementById(`zone-monster-stats-${i}`);
        function toggle() {
          stats.style.display = preset.checked ? 'none' : 'block';
          if (preset.checked) {
            const chosen = enemies.find((e) => e.name === sel.value);
            if (chosen) setZoneMonsterStats(i, chosen);
          }
        }
        preset.addEventListener('change', toggle);
        sel.addEventListener('change', () => {
          tabName.textContent = sel.value || 'Custom';
          if (preset.checked) {
            const chosen = enemies.find((e) => e.name === sel.value);
            if (chosen) setZoneMonsterStats(i, chosen);
          }
        });
        toggle();
      }
      tabs.addEventListener('click', (e) => {
        const tab = e.target.closest('.zone-tab');
        if (!tab) return;
        const idx = Number(tab.dataset.index);
        for (let j = 0; j < 5; j++) {
          document.getElementById(`zone-enemy-${j}`).style.display = j === idx ? 'block' : 'none';
          document.getElementById(`zone-tab-${j}`).classList.toggle('active', j === idx);
        }
      });
    }

    function updateMonsterStats() {
      const chosen = enemies.find((e) => e.name === enemySelect.value);
      if (chosen) setMonsterStats(chosen);
    }

    function toggleMonsterStats() {
      monsterStats.style.display = usePreset.checked ? 'none' : 'block';
      if (usePreset.checked) updateMonsterStats();
    }

    function toggleModeDisplays() {
      const mode = simModeSelect.value;
      betweenFightsLabel.style.display = mode === 'repeated' ? 'block' : 'none';
      refillSecondsLabel.style.display =
        mode === 'repeated' || mode === 'zone' ? 'block' : 'none';
      monsterConfig.style.display = mode === 'zone' ? 'none' : 'block';
      zoneConfig.style.display = mode === 'zone' ? 'block' : 'none';
      zoneSettings.style.display = mode === 'zone' ? 'block' : 'none';
    }

    simModeSelect.addEventListener('change', toggleModeDisplays);
    toggleModeDisplays();

    fetch('./enemies.json')
      .then((r) => r.json())
      .then((data) => {
        enemies = data;
        setupSingleEnemyUI();
        setupZoneEnemies();
        if (encodedData) {
          const json = LZString.decompressFromBase64(
            fromBase64Url(encodedData),
          );
          if (json) setFormData(JSON.parse(json));
        }
      });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const hero = {
        hp: Number(document.getElementById('hero-hp').value),
        maxHp: Number(document.getElementById('hero-hp').value),
        strength: Number(document.getElementById('hero-strength').value),
        defense: Number(document.getElementById('hero-defense').value),
        agility: Number(document.getElementById('hero-agility').value),
        mp: Number(document.getElementById('hero-mp').value),
        herbs: Number(document.getElementById('hero-herbs').value),
        fairyWater: Number(
          document.getElementById('hero-fairy-water').value,
        ),
        armor: document.getElementById('hero-armor').value,
        fairyFlute: document.getElementById('hero-flute').checked,
        spells: [
          ...(document.getElementById('hero-hurt').checked ? ['HURT'] : []),
          ...(document.getElementById('hero-hurtmore').checked ? ['HURTMORE'] : []),
          ...(document.getElementById('hero-heal').checked ? ['HEAL'] : []),
          ...(document.getElementById('hero-healmore').checked ? ['HEALMORE'] : []),
          ...(document.getElementById('hero-stopspell').checked ? ['STOPSPELL'] : []),
          ...(document.getElementById('hero-sleep').checked ? ['SLEEP'] : []),
          ...(document.getElementById('hero-repel').checked ? ['REPEL'] : []),
        ],
      };
      const weaponAttack = Number(document.getElementById('hero-weapon').value);
      const bonusAttack =
        (document.getElementById('hero-fighters-ring').checked ? 2 : 0) +
        (document.getElementById('hero-death-necklace').checked ? 10 : 0);
      hero.attack = hero.strength + weaponAttack + bonusAttack;
      const monster = {
        name: enemySelect.value || 'Custom',
        hp: Number(document.getElementById('mon-hp').value),
        attack: Number(document.getElementById('mon-attack').value),
        defense: Number(document.getElementById('mon-defense').value),
        agility: Number(document.getElementById('mon-agility').value),
        xp: Number(document.getElementById('mon-xp').value),
        hurtResist: Number(document.getElementById('hurt-resist').value) / 16,
        dodge: Number(document.getElementById('mon-dodge').value),
        stopspellResist: Number(document.getElementById('stopspell-resist').value) / 16,
        sleepResist: Number(document.getElementById('sleep-resist').value) / 16,
        group: Number(document.getElementById('mon-group').value),
        supportAbility: document.getElementById('mon-support').value,
        supportChance: Number(document.getElementById('mon-support-chance').value),
        attackAbility: document.getElementById('mon-attack-ability').value,
        attackChance: Number(document.getElementById('mon-attack-chance').value),
      };
        const settings = {
          heroAttackTime: Number(
            document.getElementById('hero-attack-time').value,
          ),
          heroSpellTime: Number(
            document.getElementById('hero-spell-time').value,
          ),
          heroSleepStopspellTime: Number(
            document.getElementById('hero-sleep-stopspell-time').value,
          ),
          heroSleepTime: Number(
            document.getElementById('hero-sleep-time').value,
          ),
          heroCriticalTime: Number(
            document.getElementById('hero-critical-time').value,
          ),
          herbTime: Number(document.getElementById('herb-time').value),
          fairyWaterTime: Number(
            document.getElementById('fairy-water-time').value,
          ),
          fairyFluteTime: Number(
            document.getElementById('fairy-flute-time').value,
          ),
          heroRunFailTime: Number(
            document.getElementById('hero-run-fail-time').value,
          ),
          heroRunSuccessTime: Number(
            document.getElementById('hero-run-success-time').value,
          ),
          herbBetweenTime: Number(
            document.getElementById('herb-between-time').value,
          ),
          healSpellTime: Number(
            document.getElementById('heal-spell-time').value,
          ),
          enemyAttackTime: Number(
            document.getElementById('enemy-attack-time').value,
          ),
          enemyHurtSpellTime: Number(
            document.getElementById('enemy-hurt-spell-time').value,
          ),
          enemyHealSpellTime: Number(
            document.getElementById('enemy-heal-spell-time').value,
          ),
          enemyStopspelledSpellTime: Number(
            document.getElementById('enemy-stopspelled-spell-time').value,
          ),
          enemySpellTime: Number(
            document.getElementById('enemy-spell-time').value,
          ),
          enemyBreathTime: Number(
            document.getElementById('enemy-breath-time').value,
          ),
          enemyDodgeTime: Number(
            document.getElementById('enemy-dodge-time').value,
          ),
          enemySleepTime: Number(
            document.getElementById('enemy-sleep-time').value,
          ),
          preBattleTime: Number(
            document.getElementById('pre-battle-time').value,
          ),
          postBattleTime: Number(
            document.getElementById('post-battle-time').value,
          ),
          framesBetweenFights: Number(
            document.getElementById('frames-between-fights').value,
          ),
          refillTimeSeconds: Number(
            document.getElementById('refill-seconds').value,
          ),
          ambushTime: Number(document.getElementById('ambush-time').value),
          monsterFleeTime: Number(
            document.getElementById('monster-flee-time').value,
          ),
          spellResistThreshold:
            Number(document.getElementById('spell-resist-threshold').value) / 16,
        };
      const iterations = Number(document.getElementById('iterations').value);
      const mode = document.getElementById('sim-mode').value;

      if (mode === 'zone') {
        const zoneMonsters = [];
        for (let i = 0; i < 5; i++) {
          zoneMonsters.push({
            name:
              document.getElementById(`zone-enemy-select-${i}`).value ||
              `Custom${i + 1}`,
            hp: Number(document.getElementById(`zone-mon-hp-${i}`).value),
            attack: Number(document.getElementById(`zone-mon-attack-${i}`).value),
            defense: Number(document.getElementById(`zone-mon-defense-${i}`).value),
            agility: Number(document.getElementById(`zone-mon-agility-${i}`).value),
            xp: Number(document.getElementById(`zone-mon-xp-${i}`).value),
            hurtResist:
              Number(document.getElementById(`zone-hurt-resist-${i}`).value) / 16,
            dodge: Number(document.getElementById(`zone-mon-dodge-${i}`).value),
            stopspellResist:
              Number(
                document.getElementById(`zone-stopspell-resist-${i}`).value,
              ) / 16,
            sleepResist:
              Number(document.getElementById(`zone-sleep-resist-${i}`).value) / 16,
            group: Number(document.getElementById(`zone-mon-group-${i}`).value),
            supportAbility: document.getElementById(`zone-mon-support-${i}`).value,
            supportChance: Number(
              document.getElementById(`zone-mon-support-chance-${i}`).value,
            ),
            attackAbility: document.getElementById(
              `zone-mon-attack-ability-${i}`,
            ).value,
            attackChance: Number(
              document.getElementById(`zone-mon-attack-chance-${i}`).value,
            ),
            runFrom: document.getElementById(`zone-run-${i}`).checked,
          });
        }
        const encounterRate = Number(
          document.getElementById('zone-encounter-rate').value,
        );
        const summary = simulateZone(
          hero,
          zoneMonsters,
          encounterRate,
          settings,
          iterations,
        );
        const avgXPPerLife =
          summary.averageXPPerLife ??
          (summary.xpPerMinute * summary.averageTimeSeconds) / 60;
        metricsEl.textContent =
          `Average XP per life: ${avgXPPerLife.toFixed(2)}\n` +
          `Average XP per minute: ${summary.xpPerMinute.toFixed(2)}\n` +
          `Average XP per minute (incl. refill): ${summary.xpPerMinuteWithRefill.toFixed(2)}\n` +
          `Average time per life: ${formatTime(summary.averageTimeSeconds)}\n` +
          `Average MP per minute: ${summary.mpPerMinute.toFixed(2)}`;
        sampleEl.textContent =
          `Total Time: ${formatTime(summary.timeFrames / 60)}\n` +
          `XP Gained: ${summary.xpGained}\n` +
          `MP Spent: ${summary.mpSpent}\n\n` +
          summary.log.join("\n");
        return;
      }

      const summary =
        mode === 'repeated'
          ? simulateRepeated(hero, monster, settings, iterations)
          : simulateMany(hero, monster, settings, iterations);
      let example;
      if (mode === 'repeated') {
        example = summary;
      } else {
        const hpMax = monster.hp;
        const hpMin = Math.ceil(hpMax * 0.75);
        const exampleMonster = {
          ...monster,
          hp: hpMin + Math.floor(Math.random() * (hpMax - hpMin + 1)),
        };
        example = simulateBattle(hero, exampleMonster, settings);
      }

      metricsEl.textContent =
        mode === 'repeated'
          ? `Average XP per life: ${summary.averageXPPerLife.toFixed(2)}\n` +
            `Average XP per minute: ${summary.averageXPPerMinute.toFixed(2)}\n` +
            `Average XP per minute (incl. refill): ${summary.averageXPPerMinuteWithRefill.toFixed(2)}\n` +
            `Average time per life: ${formatTime(summary.averageTimeSeconds)}\n` +
            `Average enemies defeated per life: ${summary.averageKills.toFixed(2)}\n` +
            `Average MP spent per fight: ${summary.averageMPPerFight.toFixed(2)}`
          : `Hero Win Rate: ${(summary.winRate * 100).toFixed(2)}%\n` +
            `Monster Win Rate: ${(summary.monsterWinRate * 100).toFixed(2)}%\n` +
            `Monster Flee Rate: ${(summary.monsterFleeRate * 100).toFixed(2)}%\n` +
            `Average XP per minute: ${summary.averageXPPerMinute.toFixed(2)}\n` +
            `Average MP spent per battle: ${summary.averageMPSpent.toFixed(2)}\n` +
            `Average herbs used per battle: ${summary.averageHerbsUsed.toFixed(2)}\n` +
            `Average fairy waters used per battle: ${summary.averageFairyWatersUsed.toFixed(2)}\n` +
            `Average battle time (s): ${summary.averageTimeSeconds.toFixed(2)}`;
      const logLines = example.log.slice(0, 100);
      sampleEl.textContent =
        `Total Time: ${formatTime(example.timeFrames / 60)}\n` +
        `MP Spent: ${example.mpSpent}\n` +
        `Herbs Used: ${example.herbsUsed}\n` +
        `Fairy Waters Used: ${example.fairyWatersUsed}\n` +
        logLines.join('\n');
      if (example.log.length > 100) sampleEl.textContent += '\n...';
    });
  </script>
</body>
</html>
